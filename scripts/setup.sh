#!/usr/bin/env zsh

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Dotfiles macOS Bootstrap Script (Zsh version)
# Author: Toufik Bakhtaoui
# Repo: https://github.com/toufikbakhtaoui/dotfiles
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Colors
GREEN="\033[0;32m"
BLUE="\033[0;34m"
RED="\033[0;31m"
NC="\033[0m" # No Color

echo "${BLUE}=== Automated macOS Installation and Configuration ===${NC}"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Keep sudo alive
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
sudo -v
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Prerequisites
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! xcode-select -p &>/dev/null; then
  echo "${BLUE}ğŸ”§ Installing Xcode Command Line Tools...${NC}"
  xcode-select --install
  echo "${RED}âš ï¸ Please install the tools from the popup, then re-run this script.${NC}"
  exit 1
fi

if ! dscl . -read /Groups/admin GroupMembership | grep -q "\b$USER\b"; then
  echo "${RED}âŒ User '$USER' is not admin. Add with:${NC}"
  echo "   sudo dseditgroup -o edit -a $USER -t user admin"
  exit 1
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Homebrew installation
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! command -v brew &>/dev/null; then
  echo "${BLUE}ğŸ“¦ Installing Homebrew...${NC}"
  NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  if [[ -x "/opt/homebrew/bin/brew" ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
    echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> "$HOME/.zprofile"
  elif [[ -x "/usr/local/bin/brew" ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
    echo 'eval "$(/usr/local/bin/brew shellenv)"' >> "$HOME/.zprofile"
  fi
else
  echo "${GREEN}âœ… Homebrew is already installed.${NC}"
  eval "$(brew shellenv)"
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Clone dotfiles
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REPO_URL="git@github.com:toufikbakhtaoui/macos-automated-setup.git"
DOTFILES_DIR="$HOME/macos-automated-setup"

if [[ -d "$DOTFILES_DIR/.git" ]]; then
  echo "${BLUE}ğŸ” Updating existing dotfiles...${NC}"
  cd "$DOTFILES_DIR" && git pull
else
  echo "${BLUE}ğŸ“¥ Cloning dotfiles...${NC}"
  git clone "$REPO_URL" "$DOTFILES_DIR" || {
    echo "${RED}âŒ Failed to clone dotfiles.${NC}"
    exit 1
  }
fi
cd "$DOTFILES_DIR"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Install from Brewfile
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ -f "$DOTFILES_DIR/Brewfile" ]]; then
  echo "${BLUE}ğŸ“¦ Installing packages from Brewfile...${NC}"
  brew bundle --file="$DOTFILES_DIR/Brewfile" || {
    echo "${RED}âŒ Brew bundle failed.${NC}"
    exit 1
  }
else
  echo "${RED}âŒ Brewfile not found.${NC}"
fi

# ===================================================
# Deploy dotfiles using GNU Stow
# ===================================================
echo -e "${BLUE}ğŸ”— Deploying dotfiles using Stow...${NC}"

STOW_PACKAGES=()
for dir in "$DOTFILES_DIR/dotfiles"/*/; do
  dir_name=$(basename "$dir")
  [[ "$dir_name" =~ ^(\.|.git|node_modules)$ ]] && continue
  STOW_PACKAGES+=("$dir_name")
done

if [[ ${#STOW_PACKAGES[@]} -eq 0 ]]; then
  echo -e "${RED}âŒ No directories found for stow.${NC}"
  exit 1
fi

for package in "${STOW_PACKAGES[@]}"; do
  echo -e "${GREEN}â†’ Stowing: $package${NC}"
  # Forcefully remove conflicts first
  stow -v --delete -d "$DOTFILES_DIR/dotfiles" -t "$HOME" "$package" 2>/dev/null || true
  # Then stow normally
  stow -v --restow -d "$DOTFILES_DIR/dotfiles" -t "$HOME" "$package" || {
    echo -e "${RED}âŒ Error while stowing $package${NC}"
  }
done

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# macOS defaults
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ -f "$DOTFILES_DIR/scripts/macos-defaults.sh" ]]; then
  echo "${BLUE}âš™ï¸ Applying macOS defaults...${NC}"
  zsh "$DOTFILES_DIR/scripts/macos-defaults.sh"
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# LazyVim
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "${BLUE}ğŸ§  Installing LazyVim config...${NC}"
git clone https://github.com/LazyVim/starter "$DOTFILES_DIR/dotfiles/nvim/.config/nvim"
rm -rf "$DOTFILES_DIR/dotfiles/nvim/.config/nvim/.git"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# TPM (Tmux Plugin Manager)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "${BLUE}ğŸ”Œ Installing TPM...${NC}"
git clone https://github.com/tmux-plugins/tpm "$DOTFILES_DIR/dotfiles/tmux/plugins/tpm"
rm -rf "$DOTFILES_DIR/dotfiles/tmux/plugins/tpm/.git"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Zsh setup
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "${BLUE}âš™ï¸ Applying Zsh settings...${NC}"
zsh "$DOTFILES_DIR/scripts/setup-zsh.sh" || {
  echo "${RED}âŒ Error applying Zsh settings.${NC}"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Done
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "${GREEN}âœ… Setup complete. Restart terminal or macOS to apply changes.${NC}"
